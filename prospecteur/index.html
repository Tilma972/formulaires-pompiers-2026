<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devenez Prospecteur | Calendrier 2026 Sapeurs-Pompiers</title>
  <style>
    :root {
      --primary: #e63946;
      --secondary: #1d3557;
      --light: #f1faee;
      --accent: #457b9d;
      --white: #ffffff;
    }
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 3px solid var(--primary);
      padding-bottom: 15px;
    }
    .logo {
      width: 80px;
      margin-right: 20px;
    }
    h1, h2, h3 {
      color: var(--secondary);
      margin-top: 0;
    }
    h1 {
      margin-bottom: 5px;
      font-size: 24px;
    }
    .subtitle {
      color: var(--primary);
      font-weight: bold;
      margin: 0 0 10px;
    }
    .intro {
      background-color: var(--light);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid var(--accent);
    }
    .steps {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }
    .steps ol {
      padding-left: 25px;
      margin-bottom: 0;
    }
    .form-section {
      background-color: var(--light);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent);
    }
    .section-title {
      display: inline-block;
      background-color: var(--secondary);
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    .form-row {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], 
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .search-container {
      position: relative;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      z-index: 1;
      pointer-events: none; /* Pour que les clics passent √† travers l'ic√¥ne */
    }

    .search-input {
      padding-left: 35px; /* Espace pour l'ic√¥ne */
      width: 100%;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .hidden-section {
      display: none;
    }
    .submit-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .submit-btn:hover {
      background-color: #d1282e;
    }
    .data-policy {
      font-size: 12px;
      color: #666;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .confirmation {
      text-align: center;
      padding: 50px 20px;
      background-color: var(--light);
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .confirmation h2 {
      color: var(--secondary);
    }
    .confirmation-icon {
      font-size: 60px;
      color: var(--primary);
      margin-bottom: 20px;
    }
    .error-message {
      color: var(--primary);
      font-size: 14px;
      display: none;
      margin-top: 5px;
    }
    .hidden {
      display: none;
    }
    /* Styles pour la s√©lection de commune */
    .commune-selector {
      margin-bottom: 15px;
    }
    .commune-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .commune-chip {
      background-color: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .commune-chip:hover {
      background-color: #d0d0d0;
    }
    .commune-chip.selected {
      background-color: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    /* Animation de chargement */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://n8n.aspchcrm.fr/files/Logo_pompiers.png" alt="Logo Sapeurs-Pompiers" class="logo">
      <div>
        <h1>Devenez Prospecteur pour le Calendrier 2026</h1>
        <p class="subtitle">Sapeurs-Pompiers de Clermont-l'H√©rault</p>
      </div>
    </header>
    
    <div class="intro">
      <h2>Aidez-nous √† prospecter des entreprises locales !</h2>
      <p>En tant que prospecteur volontaire, vous contribuerez directement au succ√®s de notre calendrier annuel, une ressource essentielle pour l'Amicale. Votre mission sera simple mais importante : contacter une entreprise locale pour lui proposer un encart publicitaire dans notre calendrier 2026.</p>
    </div>
    
    <div class="steps">
      <h3>Comment √ßa fonctionne :</h3>
      <ol>
        <li>S√©lectionnez une entreprise dans votre commune ou une commune voisine</li>
        <li>Recevez par email toutes les informations n√©cessaires</li>
        <li>Contactez l'entreprise dans le d√©lai choisi</li>
        <li>Communiquez-nous le r√©sultat via un second formulaire</li>
      </ol>
    </div>
    
    <form id="prospecteur-form" name="prospecteur-form" method="POST" data-netlify="true" netlify-honeypot="bot-field">
      <!-- Champs cach√©s pour Netlify -->
      <input type="hidden" name="form-name" value="prospecteur-form">
      <p class="hidden">
        <label>Ne pas remplir si vous √™tes humain : <input name="bot-field"></label>
      </p>
      
      <div class="form-section">
        <div class="section-title">VOS COORDONN√âES</div>
        <div class="form-row">
          <label for="nom_prenom">Nom et Pr√©nom *</label>
          <input type="text" id="nom_prenom" name="nom_prenom" required>
        </div>
        <div class="form-row">
          <label for="email">Adresse Email *</label>
          <input type="email" id="email" name="email" required>
        </div>
        <div class="form-row">
          <label for="telephone">T√©l√©phone</label>
          <input type="tel" id="telephone" name="telephone">
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">ATTRIBUTION DE PROSPECT</div>
        
        <!-- Champ de recherche d'entreprise -->
        <div class="form-row">
          <label for="entreprise-search">Rechercher une entreprise</label>
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input 
              type="text" 
              id="entreprise-search" 
              class="search-input" 
              placeholder="Commencez √† taper le nom d'une entreprise..."
              autocomplete="off"
            >
          </div>
        </div>
        
        <div class="form-row">
          <label for="entreprise">Choisir une entreprise *</label>
          <select id="entreprise" name="entreprise" required>
            <option value="">-- S√©lectionnez une entreprise --</option>
            <!-- Options charg√©es dynamiquement -->
          </select>
          <div id="loading-enterprises" style="display: none;"><span class="loader"></span> Chargement des entreprises...</div>
          <div class="error-message" id="entreprise-error">Veuillez s√©lectionner une entreprise</div>
        </div>
        
        <div class="form-row">
          <input type="checkbox" id="nouvelle_entreprise" name="nouvelle_entreprise">
          <label for="nouvelle_entreprise" style="display: inline;">L'entreprise que je souhaite contacter n'est pas dans la liste</label>
        </div>
        
        <!-- Section conditionnelle pour nouvelle entreprise -->
        <div id="nouvelle-entreprise-section" class="hidden-section">
          <div class="form-row">
            <label for="nom_entreprise">Nom de l'entreprise *</label>
            <input type="text" id="nom_entreprise" name="nom_entreprise">
          </div>
          <div class="form-row">
            <label for="adresse_entreprise">Adresse *</label>
            <input type="text" id="adresse_entreprise" name="adresse_entreprise">
          </div>
          
          <!-- S√©lection de commune standardis√©e -->
          <div class="form-row">
            <label for="commune_entreprise">Commune *</label>
            <select id="commune_entreprise" name="commune_entreprise">
              <option value="">-- S√©lectionnez une commune --</option>
              <!-- Options pr√©charg√©es en JavaScript -->
            </select>
            
            <!-- Section pour les communes principales (chips) -->
            <div class="commune-selector">
              <p style="font-size: 13px; margin-top: 8px; margin-bottom: 5px;">Communes principales :</p>
              <div id="commune-chips" class="commune-chips">
                <!-- Communes principales pr√©charg√©es en JavaScript -->
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="telephone_entreprise">T√©l√©phone</label>
            <input type="tel" id="telephone_entreprise" name="telephone_entreprise">
          </div>
          <div class="form-row">
            <label for="email_entreprise">Email de l'interlocuteur</label>
            <input type="email" id="email_entreprise" name="email_entreprise">
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">D√âLAI DE PROSPECTION</div>
        <div class="form-row">
          <label for="delai">Temps n√©cessaire *</label>
          <select id="delai" name="delai" required>
            <option value="3 Jours">3 Jours</option>
            <option value="7 Jours" selected>7 Jours</option>
            <option value="14 Jours">14 Jours</option>
          </select>
        </div>
      </div>
      
      <button type="submit" class="submit-btn">CONFIRMER MA PARTICIPATION</button>
      
      <div class="data-policy">
        En soumettant ce formulaire, vous acceptez que les informations saisies soient utilis√©es par l'Amicale des Sapeurs-Pompiers de Clermont l'H√©rault dans le cadre de votre participation √† la campagne de prospection pour le calendrier 2026.
      </div>
    </form>
    
    <div class="confirmation" id="confirmation">
      <div class="confirmation-icon">‚úì</div>
      <h2>Participation confirm√©e !</h2>
      <p>Merci de votre soutien aux Sapeurs-Pompiers de Clermont l'H√©rault.</p>
      <p>Vous recevrez prochainement un email avec toutes les informations n√©cessaires pour contacter l'entreprise.</p>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Liste pr√©charg√©e des communes (g√©n√©r√©e via votre API get-communes)
      const COMMUNES = [
        "ADISSAN",
        "ASPIRAN",
        "BRIGNAC",
        "CABRI√àRES",
        "CANET",
        "CEYRAS",
        "CLERMONT-L'H√âRAULT",
        "FONT√àS",
        "LACOSTE",
        "LIAUSSON", 
        "LIEURAN-CABRI√àRES",
        "M√âRIFONS",
        "MOUR√àZE",
        "N√âBIAN",
        "OCTON",
        "PAULHAN",
        "P√âRET",
        "SAINT-F√âLIX-DE-LODEZ",
        "SALASC",
        "USCLAS-D'H√âRAULT",
        "VALMASCLE",
        "VILLENEUVETTE"
        // Compl√©tez avec la liste compl√®te des communes de votre r√©gion
      ];
      
      // Communes principales pour les chips
      const COMMUNES_PRINCIPALES = [
        "CLERMONT-L'H√âRAULT", 
        "BRIGNAC", 
        "CANET", 
        "CEYRAS", 
        "LACOSTE", 
        "N√âBIAN", 
        "PAULHAN", 
        "SAINT-F√âLIX-DE-LODEZ",
        "SALASC"
      ];
      
      // Remplir le select des communes avec la liste pr√©charg√©e
      const populateCommunes = () => {
        const communeSelect = document.getElementById('commune_entreprise');
        COMMUNES.forEach(commune => {
          const option = document.createElement('option');
          option.value = commune;
          option.textContent = commune;
          communeSelect.appendChild(option);
        });
        
        // Cr√©er les chips pour les communes principales
        const communeChipsContainer = document.getElementById('commune-chips');
        COMMUNES_PRINCIPALES.forEach(commune => {
          if (COMMUNES.includes(commune)) {
            const chip = document.createElement('div');
            chip.className = 'commune-chip';
            chip.textContent = commune;
            chip.setAttribute('data-commune', commune);
            chip.addEventListener('click', function() {
              // S√©lectionner la commune correspondante dans le select
              communeSelect.value = commune;
              
              // Mise √† jour visuelle des chips
              document.querySelectorAll('.commune-chip').forEach(c => {
                c.classList.remove('selected');
              });
              this.classList.add('selected');
            });
            communeChipsContainer.appendChild(chip);
          }
        });
      };
      
      // Charger les entreprises
      const loadEnterprises = async () => {
        const loadingIndicator = document.getElementById('loading-enterprises');
        const selectElement = document.getElementById('entreprise');
        
        try {
          // Afficher l'indicateur de chargement
          loadingIndicator.style.display = 'block';
          
          // Charger les entreprises
          const response = await fetch('https://n8n.aspchcrm.fr/webhook/get-enterprises');
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des entreprises');
          }
          const enterprises = await response.json();
          
          // Trier les entreprises par commune puis par nom
          enterprises.sort((a, b) => {
            if (a.commune !== b.commune) {
              return a.commune.localeCompare(b.commune);
            }
            return a.nom_entreprise.localeCompare(b.nom_entreprise);
          });
          
          // Grouper par commune
          let currentCommune = '';
          
          enterprises.forEach(enterprise => {
            // Si on change de commune, ajouter un groupe optgroup
            if (enterprise.commune !== currentCommune) {
              currentCommune = enterprise.commune;
              const optgroup = document.createElement('optgroup');
              optgroup.label = currentCommune;
              selectElement.appendChild(optgroup);
            }
            
            // Ajouter l'option dans le dernier optgroup
            const option = document.createElement('option');
            option.value = enterprise.id;
            option.textContent = enterprise.nom_entreprise;
            selectElement.lastChild.appendChild(option);
          });
          
        } catch (error) {
          console.error('Erreur:', error);
          
          // Fallback en cas d'erreur
          const option = document.createElement('option');
          option.value = "error";
          option.textContent = "Erreur de chargement - veuillez r√©essayer plus tard";
          selectElement.appendChild(option);
          
        } finally {
          // Masquer l'indicateur de chargement
          loadingIndicator.style.display = 'none';
        }
      };
      
      // Fonction de recherche d'entreprise am√©lior√©e
      const setupEnterpriseSearch = () => {
        const searchInput = document.getElementById('entreprise-search');
        const selectElement = document.getElementById('entreprise');
  
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase().trim();
          console.log('Recherche de:', searchTerm); // D√©bogage
    
          // Si le champ est vide, restaurer toutes les options
          if (searchTerm === '') {
            const allOptions = selectElement.querySelectorAll('option');
            const allOptgroups = selectElement.querySelectorAll('optgroup');
      
            allOptions.forEach(option => {
              option.style.display = '';
            });
      
            allOptgroups.forEach(optgroup => {
            optgroup.style.display = '';
            });
      
            return;
          }
    
          const optgroups = selectElement.querySelectorAll('optgroup');
    
          // Parcourir tous les groupes (communes)
          optgroups.forEach(optgroup => {
            let hasVisibleOptions = false;
            const options = optgroup.querySelectorAll('option');
      
            // V√©rifier chaque option dans le groupe
            options.forEach(option => {
              if (option.value === '') return; // Ignorer l'option "S√©lectionnez une entreprise"
        
              const optionText = option.textContent.toLowerCase();
              const isMatch = optionText.includes(searchTerm);
        
              // Afficher/masquer l'option selon la correspondance
              if (isMatch) {
                option.style.display = '';
          hasVisibleOptions = true;
        } else {
          option.style.display = 'none';
        }
      });
      
      // Masquer le groupe entier si aucune entreprise ne correspond
      optgroup.style.display = hasVisibleOptions ? '' : 'none';
    });
  });
};
      
      // Gestion de l'affichage conditionnel
      const setupConditionalDisplay = () => {
        const checkboxNouvelleEntreprise = document.getElementById('nouvelle_entreprise');
        const sectionNouvelleEntreprise = document.getElementById('nouvelle-entreprise-section');
        const champEntreprise = document.getElementById('entreprise');
        
        checkboxNouvelleEntreprise.addEventListener('change', function() {
          if (this.checked) {
            sectionNouvelleEntreprise.style.display = 'block';
            champEntreprise.required = false;
            document.getElementById('nom_entreprise').required = true;
            document.getElementById('adresse_entreprise').required = true;
            document.getElementById('commune_entreprise').required = true;
          } else {
            sectionNouvelleEntreprise.style.display = 'none';
            champEntreprise.required = true;
            document.getElementById('nom_entreprise').required = false;
            document.getElementById('adresse_entreprise').required = false;
            document.getElementById('commune_entreprise').required = false;
          }
        });
      };
      
      // Gestion de la soumission du formulaire
      const setupFormSubmission = () => {
        const form = document.getElementById('prospecteur-form');
        
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          
          // V√©rifier que le formulaire est valide
          if (!form.checkValidity()) {
            return;
          }
          
          // Collecter les donn√©es du formulaire
          const formData = new FormData(form);
          const formObject = {};
          formData.forEach((value, key) => {
            formObject[key] = value;
          });
          
          try {
            // D√©sactiver le bouton de soumission pour √©viter les clics multiples
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="loader"></span> Envoi en cours...';
            
            // Envoyer les donn√©es au webhook n8n
            const response = await fetch('https://n8n.aspchcrm.fr/webhook/prospecteur-inscription', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(formObject)
            });
            
            if (!response.ok) {
              throw new Error('Erreur lors de l\'envoi du formulaire');
            }
            
            // Afficher la confirmation
            document.getElementById('prospecteur-form').style.display = 'none';
            document.getElementById('confirmation').style.display = 'block';
            
            // Scroll vers la confirmation
            document.getElementById('confirmation').scrollIntoView({ behavior: 'smooth' });
            
          } catch (error) {
            console.error('Erreur:', error);
            
            // R√©activer le bouton de soumission
            submitButton.disabled = false;
            submitButton.textContent = 'CONFIRMER MA PARTICIPATION';
            
            // Fallback: soumettre via Netlify Forms
            const netlifyForm = document.createElement('form');
            netlifyForm.method = 'POST';
            netlifyForm.action = '/';
            netlifyForm.setAttribute('data-netlify', 'true');
            netlifyForm.setAttribute('name', 'prospecteur-form');
            
            // Ajouter chaque champ au formulaire Netlify
            Object.keys(formObject).forEach(key => {
              if (key !== 'form-name' && key !== 'bot-field') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = formObject[key];
                netlifyForm.appendChild(input);
              }
            });
            
            // Ajouter le champ form-name
            const formNameInput = document.createElement('input');
            formNameInput.type = 'hidden';
            formNameInput.name = 'form-name';
            formNameInput.value = 'prospecteur-form';
            netlifyForm.appendChild(formNameInput);
            
            // Ajouter le formulaire au document et le soumettre
            document.body.appendChild(netlifyForm);
            netlifyForm.submit();
          }
        });
      };
      
      // Initialisation
      populateCommunes();
      loadEnterprises().then(() => {
        setupEnterpriseSearch();
      });
      setupConditionalDisplay();
      setupFormSubmission();
    });
  </script>
</body>
</html>