<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devenez Prospecteur | Calendrier 2026 Sapeurs-Pompiers</title>
  <style>
    :root {
      --primary: #e63946;
      --secondary: #1d3557;
      --light: #f1faee;
      --accent: #457b9d;
      --white: #ffffff;
    }
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 3px solid var(--primary);
      padding-bottom: 15px;
    }
    .logo {
      width: 80px;
      margin-right: 20px;
    }
    h1, h2, h3 {
      color: var(--secondary);
      margin-top: 0;
    }
    h1 {
      margin-bottom: 5px;
      font-size: 24px;
    }
    .subtitle {
      color: var(--primary);
      font-weight: bold;
      margin: 0 0 10px;
    }
    .intro {
      background-color: var(--light);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid var(--accent);
    }
    .steps {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }
    .steps ol {
      padding-left: 25px;
      margin-bottom: 0;
    }
    .form-section {
      background-color: var(--light);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent);
    }
    .section-title {
      display: inline-block;
      background-color: var(--secondary);
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    .form-row {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], 
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .search-container {
      position: relative;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      z-index: 1;
      pointer-events: none; /* Pour que les clics passent à travers l'icône */
    }

    .search-input {
      padding-left: 35px; /* Espace pour l'icône */
      width: 100%;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .hidden-section {
      display: none;
    }
    .submit-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .submit-btn:hover {
      background-color: #d1282e;
    }
    .data-policy {
      font-size: 12px;
      color: #666;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .confirmation {
      text-align: center;
      padding: 50px 20px;
      background-color: var(--light);
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .confirmation h2 {
      color: var(--secondary);
    }
    .confirmation-icon {
      font-size: 60px;
      color: var(--primary);
      margin-bottom: 20px;
    }
    .error-message {
      color: var(--primary);
      font-size: 14px;
      display: none;
      margin-top: 5px;
    }
    .hidden {
      display: none;
    }
    /* Styles pour la sélection de commune */
    .commune-selector {
      margin-bottom: 15px;
    }
    .commune-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .commune-chip {
      background-color: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .commune-chip:hover {
      background-color: #d0d0d0;
    }
    .commune-chip.selected {
      background-color: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    /* Animation de chargement */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
    }

    /* Styles for new enterprise selector */
    .select-search-container {
      position: relative;
      width: 100%;
    }

    .select-search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .select-search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(69, 123, 157, 0.2);
      outline: none;
    }

    .select-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .select-results.active {
      display: block;
    }

    .select-group-header {
      background-color: var(--secondary);
      color: white;
      padding: 8px 15px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .select-option {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s;
    }

    .select-option:hover {
      background-color: var(--light);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://s3.dsolution-ia.fr/api/v1/telecharger-objet-partage/" alt="Logo Sapeurs-Pompiers" class="logo">
      <div>
        <h1>Devenez Prospecteur pour le Calendrier 2026</h1>
        <p class="subtitle">Sapeurs-Pompiers de Clermont-l'Hérault</p>
      </div>
    </header>
    
    <div class="intro">
      <h2>Aidez-nous à prospecter des entreprises locales !</h2>
      <p>En tant que prospecteur volontaire, vous contribuerez directement au succès de notre calendrier annuel, une ressource essentielle pour l'Amicale. Votre mission sera simple mais importante : contacter une entreprise locale pour lui proposer un encart publicitaire dans notre calendrier 2026.</p>
    </div>
    
    <div class="steps">
      <h3>Comment ça fonctionne :</h3>
      <ol>
        <li>Sélectionnez une entreprise dans votre commune ou une commune voisine</li>
        <li>Recevez par email toutes les informations nécessaires</li>
        <li>Contactez l'entreprise dans le délai choisi</li>
        <li>Communiquez-nous le résultat via un second formulaire</li>
      </ol>
    </div>
    
    <form id="prospecteur-form" name="prospecteur-form" method="POST" data-netlify="true" netlify-honeypot="bot-field">
      <!-- Champs cachés pour Netlify -->
      <input type="hidden" name="form-name" value="prospecteur-form">
      <p class="hidden">
        <label>Ne pas remplir si vous êtes humain : <input name="bot-field"></label>
      </p>
      
      <div class="form-section">
        <div class="section-title">VOS COORDONNÉES</div>
        <div class="form-row">
          <label for="nom_prenom">Nom et Prénom *</label>
          <input type="text" id="nom_prenom" name="nom_prenom" required>
        </div>
        <div class="form-row">
          <label for="email">Adresse Email *</label>
          <input type="email" id="email" name="email" required>
        </div>
        <div class="form-row">
          <label for="telephone">Téléphone</label>
          <input type="tel" id="telephone" name="telephone">
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">ATTRIBUTION DE PROSPECT</div>
        
        <div class="form-row">
          <label for="entreprise">Choisir une entreprise *</label>
          <div class="select-search-container">
            <input type="text" id="entreprise-search" placeholder="Tapez pour rechercher une entreprise..." class="select-search-input">
            <div class="select-results" id="entreprise-results">
              <!-- Les résultats de recherche s'afficheront ici -->
            </div>
            <input type="hidden" id="entreprise" name="entreprise" required>
          </div>
          <div id="loading-enterprises" style="display: none;"><span class="loader"></span> Chargement des entreprises...</div>
          <div class="error-message" id="entreprise-error">Veuillez sélectionner une entreprise</div>
        </div>
        
        <div class="form-row">
          <input type="checkbox" id="nouvelle_entreprise" name="nouvelle_entreprise">
          <label for="nouvelle_entreprise" style="display: inline;">L'entreprise que je souhaite contacter n'est pas dans la liste</label>
        </div>
        
        <!-- Section conditionnelle pour nouvelle entreprise -->
        <div id="nouvelle-entreprise-section" class="hidden-section">
          <div class="form-row">
            <label for="nom_entreprise">Nom de l'entreprise *</label>
            <input type="text" id="nom_entreprise" name="nom_entreprise">
          </div>
          <div class="form-row">
            <label for="adresse_entreprise">Adresse *</label>
            <input type="text" id="adresse_entreprise" name="adresse_entreprise">
          </div>
          
          <!-- Sélection de commune standardisée -->
          <div class="form-row">
            <label for="commune_entreprise">Commune *</label>
            <select id="commune_entreprise" name="commune_entreprise">
              <option value="">-- Sélectionnez une commune --</option>
              <!-- Options préchargées en JavaScript -->
            </select>
            
            <!-- Section pour les communes principales (chips) -->
            <div class="commune-selector">
              <p style="font-size: 13px; margin-top: 8px; margin-bottom: 5px;">Communes principales :</p>
              <div id="commune-chips" class="commune-chips">
                <!-- Communes principales préchargées en JavaScript -->
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="telephone_entreprise">Téléphone</label>
            <input type="tel" id="telephone_entreprise" name="telephone_entreprise">
          </div>
          <div class="form-row">
            <label for="email_entreprise">Email de l'interlocuteur</label>
            <input type="email" id="email_entreprise" name="email_entreprise">
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">DÉLAI DE PROSPECTION</div>
        <div class="form-row">
          <label for="delai">Temps nécessaire *</label>
          <select id="delai" name="delai" required>
            <option value="3 Jours">3 Jours</option>
            <option value="7 Jours" selected>7 Jours</option>
            <option value="14 Jours">14 Jours</option>
          </select>
        </div>
      </div>
      
      <button type="submit" class="submit-btn" id="submit-button">CONFIRMER MA PARTICIPATION</button>
      
      <div class="data-policy">
        En soumettant ce formulaire, vous acceptez que les informations saisies soient utilisées par l'Amicale des Sapeurs-Pompiers de Clermont l'Hérault dans le cadre de votre participation à la campagne de prospection pour le calendrier 2026.
      </div>
    </form>
    
    <div class="confirmation" id="confirmation">
      <div class="confirmation-icon">✓</div>
      <h2>Participation confirmée !</h2>
      <p>Merci de votre soutien aux Sapeurs-Pompiers de Clermont l'Hérault.</p>
      <p>Vous recevrez prochainement un email avec toutes les informations nécessaires pour contacter l'entreprise.</p>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let enterprises = []; // To store fetched enterprise data
      // Liste préchargée des communes (générée via votre API get-communes)
      const COMMUNES = [
        "ADISSAN",
        "ASPIRAN",
        "BRIGNAC",
        "CABRIÈRES",
        "CANET",
        "CEYRAS",
        "CLERMONT-L'HÉRAULT",
        "FONTÈS",
        "LACOSTE",
        "LIAUSSON", 
        "LIEURAN-CABRIÈRES",
        "MÉRIFONS",
        "MOURÈZE",
        "NÉBIAN",
        "OCTON",
        "PAULHAN",
        "PÉRET",
        "SAINT-FÉLIX-DE-LODEZ",
        "SALASC",
        "USCLAS-D'HÉRAULT",
        "VALMASCLE",
        "VILLENEUVETTE"
        // Complétez avec la liste complète des communes de votre région
      ];
      
      // Communes principales pour les chips
      const COMMUNES_PRINCIPALES = [
        "CLERMONT-L'HÉRAULT", 
        "BRIGNAC", 
        "CANET", 
        "CEYRAS", 
        "LACOSTE", 
        "NÉBIAN", 
        "PAULHAN", 
        "SAINT-FÉLIX-DE-LODEZ",
        "SALASC"
      ];
      
      // Remplir le select des communes avec la liste préchargée
      const populateCommunes = () => {
        const communeSelect = document.getElementById('commune_entreprise');
        COMMUNES.forEach(commune => {
          const option = document.createElement('option');
          option.value = commune;
          option.textContent = commune;
          communeSelect.appendChild(option);
        });
        
        // Créer les chips pour les communes principales
        const communeChipsContainer = document.getElementById('commune-chips');
        COMMUNES_PRINCIPALES.forEach(commune => {
          if (COMMUNES.includes(commune)) {
            const chip = document.createElement('div');
            chip.className = 'commune-chip';
            chip.textContent = commune;
            chip.setAttribute('data-commune', commune);
            chip.addEventListener('click', function() {
              // Sélectionner la commune correspondante dans le select
              communeSelect.value = commune;
              
              // Mise à jour visuelle des chips
              document.querySelectorAll('.commune-chip').forEach(c => {
                c.classList.remove('selected');
              });
              this.classList.add('selected');
            });
            communeChipsContainer.appendChild(chip);
          }
        });
      };
      
      // Charger les entreprises
      const loadEnterprises = async () => {
        const loadingIndicator = document.getElementById('loading-enterprises');
        
        try {
          // Afficher l'indicateur de chargement
          loadingIndicator.style.display = 'block';
          
          // Charger les entreprises
          const response = await fetch('https://n8n.dsolution-ia.fr/webhook/get-enterprises');
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des entreprises');
          }
          
          const data = await response.json();
          console.log("Données brutes de l'API:", data);
          
          // Extraire le tableau d'entreprises en fonction du format de réponse
          let fetchedEnterprises = [];
          
          if (Array.isArray(data)) {
            fetchedEnterprises = data;
          } else if (data.enterprises && Array.isArray(data.enterprises)) {
            fetchedEnterprises = data.enterprises;
          } else if (data.json && Array.isArray(data.json)) {
            fetchedEnterprises = data.json;
          } else if (data.data && Array.isArray(data.data)) {
            fetchedEnterprises = data.data;
          }
          
          console.log("Entreprises extraites:", fetchedEnterprises);
          enterprises = fetchedEnterprises; // Assigner à la variable locale
          window.loadedEnterprises = fetchedEnterprises; // Stocker pour accès global
          
        } catch (error) {
          console.error('Erreur:', error);
          // Optionally, display an error message to the user in the new results container
          const resultsContainer = document.getElementById('entreprise-results');
          if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="select-option" style="font-style: italic; color: #999;">Erreur de chargement des entreprises.</div>';
            resultsContainer.classList.add('active');
          }
        } finally {
          // Masquer l'indicateur de chargement
          loadingIndicator.style.display = 'none';
        }
      };

      function setupEnterpriseSelector() {
        const searchInput = document.getElementById('entreprise-search');
        const resultsContainer = document.getElementById('entreprise-results');
        const hiddenInput = document.getElementById('entreprise');
        
        console.log("Configuration du sélecteur d'entreprises avec", enterprises.length, "entreprises");
        
        // Grouper les entreprises par commune
        const groupedEnterprises = {};
        enterprises.forEach(enterprise => {
          const commune = enterprise.commune || 'Autre';
          if (!groupedEnterprises[commune]) {
            groupedEnterprises[commune] = [];
          }
          groupedEnterprises[commune].push(enterprise);
        });
        
        // Fonction pour afficher les résultats filtrés
        function displayResults(searchTerm = '') {
          resultsContainer.innerHTML = '';
          resultsContainer.classList.add('active');
          
          const searchLower = searchTerm.toLowerCase();
          
          // Trier les communes alphabétiquement
          const sortedCommunes = Object.keys(groupedEnterprises).sort();
          
          sortedCommunes.forEach(commune => {
            const matchingEnterprises = groupedEnterprises[commune].filter(
              enterprise => enterprise.nom_entreprise.toLowerCase().includes(searchLower)
            );
            
            if (matchingEnterprises.length === 0) return;
            
            // Créer l'en-tête de groupe (commune)
            const groupHeader = document.createElement('div');
            groupHeader.className = 'select-group-header';
            groupHeader.textContent = commune;
            resultsContainer.appendChild(groupHeader);
            
            // Ajouter les entreprises de cette commune
            matchingEnterprises.forEach(enterprise => {
              const option = document.createElement('div');
              option.className = 'select-option';
              option.textContent = enterprise.nom_entreprise;
              option.dataset.id = enterprise.id;
              option.addEventListener('click', () => {
                console.log("Entreprise sélectionnée:", enterprise);
                hiddenInput.value = enterprise.id;
                searchInput.value = enterprise.nom_entreprise;
                resultsContainer.classList.remove('active');
              });
              resultsContainer.appendChild(option);
            });
          });
          
          // Afficher un message si aucun résultat
          if (resultsContainer.children.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'select-option';
            noResults.textContent = 'Aucun résultat trouvé';
            noResults.style.fontStyle = 'italic';
            noResults.style.color = '#999';
            resultsContainer.appendChild(noResults);
          }
        }
        
        // Événements
        searchInput.addEventListener('focus', () => displayResults(searchInput.value));
        searchInput.addEventListener('input', () => displayResults(searchInput.value));
        
        // Fermer le menu quand on clique ailleurs
        document.addEventListener('click', (e) => {
          if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.classList.remove('active');
          }
        });
      }
      
      // Gestion de l'affichage conditionnel
      const setupConditionalDisplay = () => {
        const checkboxNouvelleEntreprise = document.getElementById('nouvelle_entreprise');
        const sectionNouvelleEntreprise = document.getElementById('nouvelle-entreprise-section');
        const champEntreprise = document.getElementById('entreprise');
        
        checkboxNouvelleEntreprise.addEventListener('change', function() {
          if (this.checked) {
            sectionNouvelleEntreprise.style.display = 'block';
            champEntreprise.required = false;
            document.getElementById('nom_entreprise').required = true;
            document.getElementById('adresse_entreprise').required = true;
            document.getElementById('commune_entreprise').required = true;
          } else {
            sectionNouvelleEntreprise.style.display = 'none';
            champEntreprise.required = true;
            document.getElementById('nom_entreprise').required = false;
            document.getElementById('adresse_entreprise').required = false;
            document.getElementById('commune_entreprise').required = false;
          }
        });
      };
      
      // Gestion de la soumission du formulaire
      const setupFormSubmission = () => {
        const form = document.getElementById('prospecteur-form');
        
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          
          // Désactiver le bouton de soumission
          const submitButton = document.getElementById('submit-button');
          submitButton.disabled = true;
          submitButton.innerHTML = '<span class="loader"></span> Traitement en cours...';
          
          // Collecter les données du formulaire
          const formData = new FormData(this);
          const formObject = {};
          formData.forEach((value, key) => {
            formObject[key] = value;
          });
          
          console.log("Données initiales du formulaire:", formObject);
          
          // IMPORTANT: Enrichir les données avec l'information complète de l'entreprise
          const entrepriseId = formObject.entreprise;
          console.log("ID entreprise sélectionnée:", entrepriseId);
          console.log("Nouvelle entreprise checkbox:", formObject.nouvelle_entreprise);
          
          if (entrepriseId && formObject.nouvelle_entreprise !== 'on') {
            console.log("Tentative d'enrichissement des données d'entreprise");
            
            // Vérifier si les entreprises sont chargées
            const enterprises = window.loadedEnterprises || [];
            console.log("Entreprises disponibles:", enterprises.length);
            
            // Utilisation de String() pour comparer correctement les IDs
            const selectedEnterprise = enterprises.find(e => String(e.id) === String(entrepriseId));
            console.log("Entreprise trouvée:", selectedEnterprise);
            
            if (selectedEnterprise) {
              // Extraction de la valeur de commune (qui peut être un objet ou une chaîne)
              const commune = typeof selectedEnterprise.commune === 'object' && selectedEnterprise.commune !== null 
                ? selectedEnterprise.commune.value || '' 
                : selectedEnterprise.commune || '';
              
              // Ajout des champs enrichis
              formObject.entreprise_nom = selectedEnterprise.nom_entreprise || '';
              formObject.entreprise_commune = commune;
              formObject.entreprise_adresse = selectedEnterprise.adresse || '';
              formObject.entreprise_telephone = selectedEnterprise.telephone || selectedEnterprise.portable || '';
              formObject.entreprise_email = selectedEnterprise.email || '';
              
              console.log("Données enrichies:", formObject);
            }
          }
          
          try {
            console.log("Données envoyées au webhook:", JSON.stringify(formObject));
            
            // Envoyer les données au webhook n8n
            const response = await fetch('https://n8n.aspchcrm.fr/webhook/prospecteur-inscription', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(formObject)
            });
            
            if (!response.ok) {
              throw new Error('Erreur lors de l\'envoi du formulaire');
            }
            
            console.log("Réponse du webhook:", await response.json().catch(() => ({})));
            
            // Afficher la confirmation
            document.getElementById('prospecteur-form').style.display = 'none';
            document.getElementById('confirmation').style.display = 'block';
            document.getElementById('confirmation').scrollIntoView({ behavior: 'smooth' });
            
          } catch (error) {
            console.error('Erreur:', error);
            // Réactiver le bouton
            submitButton.disabled = false;
            submitButton.innerHTML = 'CONFIRMER MA PARTICIPATION';
            
            // Fallback Netlify Forms si nécessaire...
            const netlifyForm = document.createElement('form');
            netlifyForm.method = 'POST';
            netlifyForm.action = '/';
            netlifyForm.setAttribute('data-netlify', 'true');
            netlifyForm.setAttribute('name', 'prospecteur-form');
            
            Object.keys(formObject).forEach(key => {
              if (key !== 'form-name' && key !== 'bot-field') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = formObject[key];
                netlifyForm.appendChild(input);
              }
            });
            
            // Ajouter le champ form-name pour Netlify
            const formNameInput = document.createElement('input');
            formNameInput.type = 'hidden';
            formNameInput.name = 'form-name';
            formNameInput.value = 'prospecteur-form';
            netlifyForm.appendChild(formNameInput);
            
            document.body.appendChild(netlifyForm);
            netlifyForm.submit();
          }
        });
      };
      
      // Initialisation
      populateCommunes();
      loadEnterprises().then(() => {
        setupEnterpriseSelector();
      });
      setupConditionalDisplay();
      setupFormSubmission();
    });
  </script>
</body>
</html>
