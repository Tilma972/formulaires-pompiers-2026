<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qualification Prospect | Calendrier 2026 Sapeurs-Pompiers</title>
  <style>
    :root {
      --primary: #e63946;
      --secondary: #1d3557;
      --light: #f1faee;
      --accent: #457b9d;
      --white: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
    }
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 3px solid var(--primary);
      padding-bottom: 15px;
    }
    .logo {
      width: 80px;
      margin-right: 20px;
    }
    h1, h2, h3 {
      color: var(--secondary);
      margin-top: 0;
    }
    h1 {
      margin-bottom: 5px;
      font-size: 24px;
    }
    .subtitle {
      color: var(--primary);
      font-weight: bold;
      margin: 0 0 10px;
    }
    .intro {
      background-color: var(--light);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid var(--accent);
    }
    .form-section {
      background-color: var(--light);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent);
    }
    .highlight-section {
      background-color: #fff8e1;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #ffc107;
    }
    .section-title {
      display: inline-block;
      background-color: var(--secondary);
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    .highlight-title {
      display: inline-block;
      background-color: #ff9800;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    .form-row {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], 
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .radio-group, .checkbox-group {
      margin-top: 5px;
    }
    .radio-option, .checkbox-option {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .radio-option input, .checkbox-option input {
      margin-right: 10px;
    }
    .radio-option label, .checkbox-option label {
      font-weight: normal;
      margin-bottom: 0;
    }
    .interest-levels {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
    }
    .interest-level {
      flex: 1;
      text-align: center;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .interest-level:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
    }
    .interest-level.selected {
      border-color: var(--primary);
      background-color: rgba(230, 57, 70, 0.1);
    }
    .interest-level.high {
      border-color: var(--success);
    }
    .interest-level.medium {
      border-color: var(--warning);
    }
    .interest-level.low {
      border-color: var(--danger);
    }
    .interest-level.not-interested {
      border-color: #999;
    }
    .interest-level.selected.high {
      background-color: rgba(76, 175, 80, 0.1);
    }
    .interest-level.selected.medium {
      background-color: rgba(255, 152, 0, 0.1);
    }
    .interest-level.selected.low {
      background-color: rgba(244, 67, 54, 0.1);
    }
    .interest-level.selected.not-interested {
      background-color: rgba(153, 153, 153, 0.1);
    }
    .format-options {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 15px 0;
    }
    .format-option {
      flex: 1;
      min-width: 180px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    .format-option:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
    }
    .format-option.selected {
      border-color: var(--primary);
      background-color: rgba(230, 57, 70, 0.1);
    }
    .price {
      font-size: 22px;
      font-weight: bold;
      color: var(--primary);
      margin: 10px 0;
    }
    .format-desc {
      font-size: 14px;
      color: #666;
    }
    .month-selector {
      margin: 20px 0;
    }
    .month-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .month-btn {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .month-btn:hover {
      background-color: #f0f0f0;
    }
    .month-btn.selected {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .conditional-section {
      display: none;
    }
    .submit-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .submit-btn:hover {
      background-color: #d1282e;
    }
    .data-policy {
      font-size: 12px;
      color: #666;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .confirmation {
      text-align: center;
      padding: 50px 20px;
      background-color: var(--light);
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .confirmation h2 {
      color: var(--secondary);
    }
    .confirmation-icon {
      font-size: 60px;
      color: var(--primary);
      margin-bottom: 20px;
    }
    .error-message {
      color: var(--primary);
      font-size: 14px;
      display: none;
      margin-top: 5px;
    }
    .hidden {
      display: none;
    }
    .reason-section {
      background-color: rgba(255, 152, 0, 0.1);
      padding: 15px;
      border-radius: 5px;
      border-left: 3px solid var(--warning);
      margin-top: 15px;
      margin-bottom: 15px;
      display: none;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      .month-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .month-btn {
        padding: 8px 6px;
        font-size: 12px; /* Réduire la taille de police */
      }
      .format-options {
        flex-direction: column;
      }
      .interest-levels {
        flex-wrap: wrap;
      }
      .interest-level {
        flex-basis: 48%;
        margin-bottom: 10px;
      }
    }

    @media (max-width: 480px) {
      .month-btn {
        padding: 6px 4px;
        font-size: 11px; /* Encore plus petit pour les très petits écrans */
      }
    }

    #section-mode-livraison {
      margin-top: 10px;
      padding-left: 25px;
      transition: all 0.3s ease;
      border-left: 2px solid #f1faee;
    }

    #section-mode-livraison.active {
      border-left: 2px solid var(--primary);
    }

    /* Animation de transition pour l'affichage */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #section-mode-livraison {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://s3.dsolution-ia.fr/logos/logo-pompier.png" alt="Logo Sapeurs-Pompiers" class="logo">
      <div>
        <h1>Qualification Prospect</h1>
        <p class="subtitle">Calendrier 2026 des Sapeurs-Pompiers de Clermont-l'Hérault</p>
      </div>
    </header>
    
    <div class="intro">
      <p>Ce formulaire vous permet de transmettre les informations obtenues lors de votre contact avec l'entreprise qui vous a été attribuée. Que l'entreprise soit intéressée ou non, ces données sont précieuses pour notre campagne.</p>
      <p>Merci de compléter avec soin toutes les sections pertinentes - votre contribution est essentielle au succès de notre calendrier 2026 !</p>
    </div>
    
    <form id="qualification-form" name="qualification-form" method="POST" data-netlify="true" netlify-honeypot="bot-field">
      <!-- Champs cachés pour Netlify -->
      <input type="hidden" name="form-name" value="qualification-form">
      <input type="hidden" id="prospecteur_id" name="prospecteur_id" value="">
      <p class="hidden">
        <label>Ne pas remplir si vous êtes humain : <input name="bot-field"></label>
      </p>
      
      <div class="form-section">
        <div class="section-title">ÉTAPE 1 : INFORMATIONS DE CONTACT</div>
      
        <div class="form-row">
          <label for="entreprise_display">Entreprise contactée</label>
          <input type="text" id="entreprise_display" readonly style="background-color: #f5f5f5;">
          <input type="hidden" id="entreprise" name="entreprise" required>
        </div>
        
        <div class="form-row">
          <label for="commune_entreprise">Commune de l'entreprise</label>
          <input type="text" id="commune_entreprise" name="commune_entreprise" readonly style="background-color: #f5f5f5;">
        </div>
        
        <div class="form-row">
          <label for="interlocuteur">Nom du contact *</label>
          <input type="text" id="interlocuteur" name="interlocuteur" required>
        </div>
        
        <div class="form-row">
          <label for="email_contact">Email de contact *</label>
          <input type="email" id="email_contact" name="email_contact" required>
        </div>
        
        <div class="form-row">
          <label for="telephone_contact">Téléphone de contact</label>
          <input type="tel" id="telephone_contact" name="telephone_contact">
        </div>
        
        <div class="form-row">
          <label for="date_contact">Date du contact</label>
          <input type="date" id="date_contact" name="date_contact" value="">
        </div>
      </div>
      
      <div class="highlight-section">
        <div class="highlight-title">ÉTAPE 2 : NIVEAU D'INTÉRÊT</div>
        <p>Qualifiez le niveau d'intérêt de l'entreprise pour une participation au calendrier 2026 :</p>
        
        <div class="interest-levels">
          <div class="interest-level high" data-value="Très intéressé" onclick="selectInterestLevel(this)">
            <h3>Très intéressé</h3>
            <p>Prêt à commander</p>
          </div>
          <div class="interest-level medium" data-value="Intéressé" onclick="selectInterestLevel(this)">
            <h3>Intéressé</h3>
            <p>Demande réflexion</p>
          </div>
          <div class="interest-level low" data-value="Peu intéressé" onclick="selectInterestLevel(this)">
            <h3>Peu intéressé</h3>
            <p>Besoin de relance</p>
          </div>
          <div class="interest-level not-interested" data-value="Pas intéressé" onclick="selectInterestLevel(this)">
            <h3>Pas intéressé</h3>
            <p>Refus définitif</p>
          </div>
        </div>
        <input type="hidden" id="niveau_interet" name="niveau_interet" required>
        <div class="error-message" id="interet-error">Veuillez sélectionner un niveau d'intérêt</div>
        
        <!-- Nouvelle section pour la raison de réflexion -->
        <div id="section-raison-reflexion" class="reason-section">
          <label for="raison_reflexion">Raison principale de la réflexion :</label>
          <select id="raison_reflexion" name="raison_reflexion">
            <option value="">-- Sélectionnez --</option>
            <option value="Budget">Budget / Prix</option>
            <option value="Validation">Validation hiérarchique nécessaire</option>
            <option value="Format">Choix du format</option>
            <option value="Comparaison supports">Comparaison avec d'autres supports</option>
            <option value="Autre">Autre raison</option>
          </select>
        </div>
      </div>
      
      <!-- Section conditionnelle pour les prospects intéressés -->
      <div id="section-interesses" class="conditional-section">
        <div class="form-section">
          <div class="section-title">DÉTAILS DE LA COMMANDE</div>
          
          <div class="format-options">
            <div class="format-option" data-format="6X4" onclick="selectFormat('6X4')">
              <h3>Format 6X4cm</h3>
              <div class="price">350€</div>
              <div class="format-desc">Format carte de visite</div>
            </div>
            <div class="format-option" data-format="6X8" onclick="selectFormat('6X8')">
              <h3>Format 6X8cm</h3>
              <div class="price">500€</div>
              <div class="format-desc">Visibilité améliorée</div>
            </div>
            <div class="format-option" data-format="12X4" onclick="selectFormat('12X4')">
              <h3>Format 12X4cm</h3>
              <div class="price">500€</div>
              <div class="format-desc">Format bandeau</div>
            </div>
            <div class="format-option" data-format="12PARUTIONS" onclick="selectFormat('12PARUTIONS')">
              <h3>12 Parutions</h3>
              <div class="price">1800€</div>
              <div class="format-desc">Format 6x4 toute l'année</div>
            </div>
          </div>
          <input type="hidden" id="format_encart" name="format_encart">
          <div class="error-message" id="format-error">Veuillez sélectionner un format d'encart</div>
          
          <div class="form-row">
            <label for="offre_annuelle">S'agit-il d'une offre annuelle?</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="offre_annuelle_oui" name="offre_annuelle" value="Oui" onchange="toggleOffreAnnuelle(true)">
                <label for="offre_annuelle_oui">Oui</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="offre_annuelle_non" name="offre_annuelle" value="Non" checked onchange="toggleOffreAnnuelle(false)">
                <label for="offre_annuelle_non">Non</label>
              </div>
            </div>
          </div>
          
          <div id="section-nombre-parutions" class="form-row">
            <label for="nombre_parutions">Nombre de parutions souhaitées</label>
            <input type="number" id="nombre_parutions" name="nombre_parutions" min="1" max="12" value="1">
          </div>
          
          <div id="section-mois-parution">
            <label>Sélectionnez le ou les mois de parution</label>
            <div class="month-grid">
              <div class="month-btn" data-month="Janvier" onclick="toggleMonth(this)">Janvier</div>
              <div class="month-btn" data-month="Février" onclick="toggleMonth(this)">Février</div>
              <div class="month-btn" data-month="Mars" onclick="toggleMonth(this)">Mars</div>
              <div class="month-btn" data-month="Avril" onclick="toggleMonth(this)">Avril</div>
              <div class="month-btn" data-month="Mai" onclick="toggleMonth(this)">Mai</div>
              <div class="month-btn" data-month="Juin" onclick="toggleMonth(this)">Juin</div>
              <div class="month-btn" data-month="Juillet" onclick="toggleMonth(this)">Juillet</div>
              <div class="month-btn" data-month="Août" onclick="toggleMonth(this)">Août</div>
              <div class="month-btn" data-month="Septembre" onclick="toggleMonth(this)">Septembre</div>
              <div class="month-btn" data-month="Octobre" onclick="toggleMonth(this)">Octobre</div>
              <div class="month-btn" data-month="Novembre" onclick="toggleMonth(this)">Novembre</div>
              <div class="month-btn" data-month="Décembre" onclick="toggleMonth(this)">Décembre</div>
            </div>
            <input type="hidden" id="mois_parution" name="mois_parution">
            <div class="error-message" id="month-error">Veuillez sélectionner au moins un mois de parution</div>
          </div>
        </div>
        
        <div class="form-section">
          <div class="section-title">ACTIONS IMMÉDIATES</div>
          
          <div class="form-row">
            <label>Actions à réaliser pour ce prospect :</label>
            <div class="checkbox-group">
              <div class="checkbox-option">
                <input type="checkbox" id="email_remerciement" name="email_remerciement" value="Oui">
                <label for="email_remerciement">Envoyer un email de remerciement</label>
              </div>
              <div class="checkbox-option">
                <input type="checkbox" id="generer_bon_commande" name="generer_bon_commande" value="Oui">
                <label for="generer_bon_commande">Générer un bon de commande automatiquement</label>
              </div>
            </div>
          </div>
          
          <div id="section-mode-livraison" class="form-row" style="display: none;">
            <label for="mode_livraison_bdc">Mode de livraison du bon de commande :</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="livraison_email" name="mode_livraison_bdc" value="email" checked>
                <label for="livraison_email">Envoi par email</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="livraison_main_propre" name="mode_livraison_bdc" value="main_propre">
                <label for="livraison_main_propre">Remise en main propre par le prospecteur</label>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <label for="mode_paiement">Mode de paiement préféré</label>
            <select id="mode_paiement" name="mode_paiement">
              <option value="">-- Sélectionnez --</option>
              <option value="Virement">Virement bancaire</option>
              <option value="Cheque">Chèque</option>
              <option value="Carte">Carte bancaire</option>
              <option value="Espèces">Espèces</option>
              <option value="Non défini">À définir</option>
            </select>
          </div>
          
          <div class="form-row">
            <label for="date_relance">Date de relance souhaitée</label>
            <input type="date" id="date_relance" name="date_relance">
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">NOTES ET COMMENTAIRES</div>
        <div class="form-row">
          <label for="commentaires">Informations complémentaires, demandes spécifiques, etc.</label>
          <textarea id="commentaires" name="commentaires" rows="4"></textarea>
        </div>
      </div>
      
      <button type="submit" class="submit-btn" id="submit-button">SOUMETTRE LA QUALIFICATION</button>
      
      <div class="data-policy">
        En soumettant ce formulaire, vous confirmez que les informations fournies sont exactes et qu'elles peuvent être utilisées par l'Amicale des Sapeurs-Pompiers de Clermont l'Hérault dans le cadre de la campagne du calendrier 2026.
      </div>
    </form>
    
    <div class="confirmation" id="confirmation">
      <div class="confirmation-icon">✓</div>
      <h2>Qualification enregistrée avec succès !</h2>
      <p>Merci pour votre travail de prospection auprès de cette entreprise.</p>
      <p>L'équipe de coordination prendra en charge le suivi selon les indications que vous avez fournies.</p>
    </div>
  </div>
  
  <script>
    // Variables globales
    let selectedMonths = [];
    let communesLoaded = false;
    
    
    // Récupérer les entreprises depuis l'API existante
    async function loadEnterprisesAndCommunes() {
      try {
        // Afficher un indicateur de chargement
        const enterpriseDisplay = document.getElementById('entreprise_display');
        const originalValue = enterpriseDisplay.value;
        enterpriseDisplay.value = "Chargement des données...";
        
        // Les communes seront chargées automatiquement
        
        const response = await fetch('https://n8n.dsolution-ia.fr/webhook/get-enterprises');
        if (!response.ok) {
          throw new Error('Erreur lors du chargement des données');
        }
        
        const data = await response.json();
        console.log('Données reçues de l\'API:', data);
        
        // Restaurer la valeur originale
        enterpriseDisplay.value = originalValue;
        
        // Si les données sont un tableau d'entreprises (ancien format)
        if (Array.isArray(data)) {
          console.log('Format de données: tableau simple');
          return data;
        } 
        // Si les données contiennent des entreprises et communes (nouveau format)
        else if (data.enterprises || data.communes) {
          console.log('Format de données: objet avec enterprises et communes');
          return data.enterprises || [];
        }
        // Format inconnu, essayer de deviner
        else {
          console.warn('Format de données inconnu, tentative d\'interprétation');
          let enterprises = [];
          
          if (typeof data === 'object' && data !== null) {
            if (data.json && Array.isArray(data.json)) {
              enterprises = data.json;
            } else {
              enterprises = [data];
            }
          }
          
          return enterprises;
        }
      } catch (error) {
        console.error('Erreur lors du chargement des entreprises:', error);
        // En cas d'erreur, créer des données factices pour permettre au formulaire de fonctionner
        const mockEnterprises = [];
        
        // Récupérer l'entreprise depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const enterpriseId = urlParams.get('eid') || urlParams.get('id');
        const enterpriseName = urlParams.get('nom');
        
        if (enterpriseId && enterpriseName) {
          mockEnterprises.push({
            id: enterpriseId,
            nom_entreprise: decodeURIComponent(enterpriseName),
            commune: "CLERMONT-L'HERAULT"
          });
        }
        
        // Restaurer l'affichage
        const enterpriseDisplay = document.getElementById('entreprise_display');
        enterpriseDisplay.value = enterpriseName ? decodeURIComponent(enterpriseName) : "";
        
        return mockEnterprises;
      }
    }
    
    
    // Récupérer l'ID du prospecteur et autres paramètres depuis l'URL
    document.addEventListener('DOMContentLoaded', function() {
      // Charger les entreprises et communes
      loadEnterprisesAndCommunes().then(enterprises => {
        console.log(`${enterprises.length} entreprises chargées`);
      });
      
      const urlParams = new URLSearchParams(window.location.search);
      const prospecteurId = urlParams.get('pid');
      const entrepriseId = urlParams.get('eid') || urlParams.get('id');
      const entrepriseNom = urlParams.get('nom');
      
      // Préremplir les champs à partir des paramètres d'URL
      const interlocuteur = urlParams.get('interlocuteur');
      const email = urlParams.get('email');
      const telephone = urlParams.get('telephone');
      const format = urlParams.get('format');
      const mois = urlParams.get('mois');
      const commune = urlParams.get('commune');
      
      console.log('Paramètres URL extraits:', { prospecteurId, entrepriseId, entrepriseNom, interlocuteur, email, telephone, format, mois, commune });
      
      // Remplir le champ prospecteur_id
      if (prospecteurId) {
        document.getElementById('prospecteur_id').value = prospecteurId;
      }
      
      // Remplir les champs d'entreprise
      if (entrepriseId) {
        document.getElementById('entreprise').value = entrepriseId;
      }
      
      if (entrepriseNom) {
        try {
          const nomDecodé = decodeURIComponent(entrepriseNom);
          document.getElementById('entreprise_display').value = nomDecodé;
        } catch(e) {
          document.getElementById('entreprise_display').value = entrepriseNom;
        }
      }
      
      // Si la commune est spécifiée, attendre que les communes soient chargées puis la sélectionner
      if (commune) {
        const communeSelect = document.getElementById('commune_entreprise');
        
        // La commune sera définie automatiquement
      }
      
      // Remplir les autres champs s'ils existent dans l'URL
      if (interlocuteur) {
        try {
          document.getElementById('interlocuteur').value = decodeURIComponent(interlocuteur);
          console.log('Champ interlocuteur rempli avec:', decodeURIComponent(interlocuteur));
        } catch(e) {
          document.getElementById('interlocuteur').value = interlocuteur;
          console.log('Champ interlocuteur rempli sans décodage:', interlocuteur);
        }
      }
      
      if (email) {
        try {
          document.getElementById('email_contact').value = decodeURIComponent(email);
          console.log('Champ email_contact rempli avec:', decodeURIComponent(email));
        } catch(e) {
          document.getElementById('email_contact').value = email;
          console.log('Champ email_contact rempli sans décodage:', email);
        }
      }
      
      if (telephone) {
        try {
          document.getElementById('telephone_contact').value = decodeURIComponent(telephone);
          console.log('Champ telephone_contact rempli avec:', decodeURIComponent(telephone));
        } catch(e) {
          document.getElementById('telephone_contact').value = telephone;
          console.log('Champ telephone_contact rempli sans décodage:', telephone);
        }
      }
      
      // Définir la date du jour pour le champ date_contact
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date_contact').value = today;
      
      // Après le chargement des entreprises et une fois que l'entreprise est sélectionnée
      // (si le format et le mois sont spécifiés dans l'URL), préselectionner ces valeurs
      if (format || mois) {
        setTimeout(() => {
          console.log('Tentative de pré-sélection du format et mois');
          const interestedOption = document.querySelector('.interest-level[data-value="Très intéressé"]');
          if (interestedOption) {
            selectInterestLevel(interestedOption);
            console.log('Niveau d\'intérêt "Très intéressé" sélectionné');
            
            if (format) {
              selectFormat(format);
              console.log('Format sélectionné:', format);
            }
            
            if (mois) {
              setTimeout(() => {
                const monthElement = document.querySelector(`.month-btn[data-month="${mois}"]`);
                if (monthElement) {
                  toggleMonth(monthElement);
                  console.log('Mois sélectionné:', mois);
                } else {
                  console.warn(`Bouton pour le mois ${mois} non trouvé`);
                }
              }, 200);
            }
          } else {
            console.warn('Élément niveau d\'intérêt non trouvé');
          }
        }, 500);
      }
      
      // Ajouter ceci à la fin de l'écouteur existant
      toggleModeLivraison();
    });

    // Ajouter un écouteur d'événement pour le checkbox de génération du bon de commande
    document.getElementById('generer_bon_commande').addEventListener('change', toggleModeLivraison);

    // Fonction pour afficher/masquer le mode de livraison en fonction de la case à cocher
    function toggleModeLivraison() {
      const generateBonCommande = document.getElementById('generer_bon_commande').checked;
      const sectionModeLivraison = document.getElementById('section-mode-livraison');
      
      if (generateBonCommande) {
        sectionModeLivraison.style.display = 'block';
      } else {
        sectionModeLivraison.style.display = 'none';
      }
    }
    
    // Sélection du niveau d'intérêt
    function selectInterestLevel(element) {
      // Retirer la classe selected de tous les éléments
      document.querySelectorAll('.interest-level').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Ajouter la classe selected à l'élément cliqué
      element.classList.add('selected');
      
      // Mettre à jour le champ caché
      const value = element.getAttribute('data-value');
      document.getElementById('niveau_interet').value = value;
      document.getElementById('interet-error').style.display = 'none';
      
      // Afficher ou masquer les sections conditionnelles selon le niveau d'intérêt
      const sectionInteresses = document.getElementById('section-interesses');
      const sectionRaisonReflexion = document.getElementById('section-raison-reflexion');
      
      if (value === 'Très intéressé' || value === 'Intéressé') {
        sectionInteresses.style.display = 'block';
        
        // Afficher la section raison de réflexion uniquement pour "Intéressé"
        if (value === 'Intéressé') {
          sectionRaisonReflexion.style.display = 'block';
        } else {
          sectionRaisonReflexion.style.display = 'none';
        }
      } else {
        sectionInteresses.style.display = 'none';
        sectionRaisonReflexion.style.display = 'none';
      }
      
      // Pour les niveaux d'intérêt positifs, cocher automatiquement "Envoyer un email"
      const emailRemerciement = document.getElementById('email_remerciement');
      if (value === 'Très intéressé' || value === 'Intéressé') {
        emailRemerciement.checked = true;
      }
      
      // Pour "Très intéressé", cocher aussi "Générer bon de commande"
      const genererBonCommande = document.getElementById('generer_bon_commande');
      if (value === 'Très intéressé') {
        genererBonCommande.checked = true;
        // Afficher le mode de livraison quand le bon de commande est coché
        toggleModeLivraison();
      } else {
        genererBonCommande.checked = false;
        // Masquer le mode de livraison quand le bon de commande est décoché
        toggleModeLivraison();
      }
    }
    
    // Sélection du format d'encart
    function selectFormat(format) {
      // Retirer la classe selected de tous les éléments
      document.querySelectorAll('.format-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Ajouter la classe selected à l'élément correspondant au format
      const selectedOption = document.querySelector(`.format-option[data-format="${format}"]`);
      if (selectedOption) {
        selectedOption.classList.add('selected');
        document.getElementById('format_encart').value = format;
        document.getElementById('format-error').style.display = 'none';
      }
      
      // Si format 12PARUTIONS, sélectionner automatiquement offre annuelle
      if (format === '12PARUTIONS') {
        document.getElementById('offre_annuelle_oui').checked = true;
        document.getElementById('nombre_parutions').value = 12;
        toggleOffreAnnuelle(true);
      }
    }
    
    // Gestion de l'offre annuelle
    function toggleOffreAnnuelle(isAnnual) {
      const sectionMoisParution = document.getElementById('section-mois-parution');
      const sectionNombreParutions = document.getElementById('section-nombre-parutions');
      
      if (isAnnual) {
        // Pour une offre annuelle, cacher la sélection de mois et fixer le nombre de parutions à 12
        sectionMoisParution.style.display = 'none';
        document.getElementById('nombre_parutions').value = 12;
        
        // Remplir automatiquement tous les mois
        selectedMonths = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
        document.getElementById('mois_parution').value = selectedMonths.join(',');
      } else {
        // Pour une offre non annuelle, montrer la sélection de mois
        sectionMoisParution.style.display = 'block';
        
        // Réinitialiser les mois sélectionnés
        selectedMonths = [];
        document.getElementById('mois_parution').value = '';
        document.querySelectorAll('.month-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
      }
    }
    
    // Sélection des mois
    function toggleMonth(element) {
      const month = element.getAttribute('data-month');
      
      if (element.classList.contains('selected')) {
        // Désélectionner le mois
        element.classList.remove('selected');
        selectedMonths = selectedMonths.filter(m => m !== month);
      } else {
        // Vérifier si le nombre maximum de mois est atteint
        const nombreParutions = parseInt(document.getElementById('nombre_parutions').value) || 1;
        if (selectedMonths.length < nombreParutions) {
          // Sélectionner le mois
          element.classList.add('selected');
          selectedMonths.push(month);
        } else {
          // Afficher une alerte si le nombre maximum est atteint
          alert(`Vous ne pouvez sélectionner que ${nombreParutions} mois. Pour en sélectionner plus, augmentez le nombre de parutions.`);
          return;
        }
      }
      
      // Mettre à jour le champ caché
      document.getElementById('mois_parution').value = selectedMonths.join(',');
      
      // Gérer l'erreur
      if (selectedMonths.length > 0) {
        document.getElementById('month-error').style.display = 'none';
      }
    }
    
    // Mise à jour du nombre maximum de mois sélectionnables
    document.getElementById('nombre_parutions').addEventListener('change', function() {
      const nombreParutions = parseInt(this.value) || 1;
      const offre_annuelle = document.getElementById('offre_annuelle_oui').checked;
      
      if (offre_annuelle) {
        this.value = 12;
        return;
      }
      
      // Si le nombre de parutions a diminué et qu'il y a plus de mois sélectionnés
      if (selectedMonths.length > nombreParutions) {
        const excessMonths = selectedMonths.length - nombreParutions;
        for (let i = 0; i < excessMonths; i++) {
          const monthToRemove = selectedMonths.pop();
          const monthElement = document.querySelector(`.month-btn[data-month="${monthToRemove}"]`);
          if (monthElement) {
            monthElement.classList.remove('selected');
          }
        }
        
        // Mettre à jour le champ caché
        document.getElementById('mois_parution').value = selectedMonths.join(',');
      }
    });
    
    // Validation du formulaire
    document.getElementById('qualification-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      // Désactiver le bouton de soumission pour éviter les soumissions multiples
      const submitButton = document.getElementById('submit-button');
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="loading"></span> Traitement en cours...';
      
      // Vérifier que le niveau d'intérêt est sélectionné
      const niveauInteret = document.getElementById('niveau_interet').value;
      if (!niveauInteret) {
        document.getElementById('interet-error').style.display = 'block';
        document.querySelector('.highlight-section').scrollIntoView({ behavior: 'smooth' });
        submitButton.disabled = false;
        submitButton.innerHTML = 'SOUMETTRE LA QUALIFICATION';
        return;
      }
      
      // Validation spécifique pour les raisons de réflexion si "Intéressé"
      if (niveauInteret === 'Intéressé') {
        const raisonReflexion = document.getElementById('raison_reflexion').value;
        if (!raisonReflexion) {
          alert('Veuillez sélectionner la raison principale de réflexion');
          document.getElementById('raison_reflexion').focus();
          submitButton.disabled = false;
          submitButton.innerHTML = 'SOUMETTRE LA QUALIFICATION';
          return;
        }
      }
      
      // Pour les prospects intéressés, vérifier les champs additionnels
      if (niveauInteret === 'Très intéressé' || niveauInteret === 'Intéressé') {
        // Vérifier que le format est sélectionné
        const formatEncart = document.getElementById('format_encart').value;
        if (!formatEncart) {
          document.getElementById('format-error').style.display = 'block';
          document.querySelector('.format-options').scrollIntoView({ behavior: 'smooth' });
          submitButton.disabled = false;
          submitButton.innerHTML = 'SOUMETTRE LA QUALIFICATION';
          return;
        }
        
        // Vérifier que les mois sont sélectionnés pour une offre non annuelle
        const offreAnnuelle = document.getElementById('offre_annuelle_oui').checked;
        if (!offreAnnuelle && selectedMonths.length === 0) {
          document.getElementById('month-error').style.display = 'block';
          document.getElementById('section-mois-parution').scrollIntoView({ behavior: 'smooth' });
          submitButton.disabled = false;
          submitButton.innerHTML = 'SOUMETTRE LA QUALIFICATION';
          return;
        }
      }
      
      // Collecter les données du formulaire
      const formData = new FormData(this);
      const formObject = {};
      formData.forEach((value, key) => {
        formObject[key] = value;
      });
      
      // Ajouter également la commune sélectionnée
      const communeSelect = document.getElementById('commune_entreprise');
      if (communeSelect && communeSelect.value) {
        formObject.commune = communeSelect.value;
      }
      
      // Calculer le prix total basé sur format et nombre de parutions
      formObject.prix_total = calculatePrice(formObject.format_encart, parseInt(formObject.nombre_parutions) || 1);
      
      // S'assurer que le mode de livraison est correctement inclus si le bon de commande est demandé
      if (formObject.generer_bon_commande === "Oui") {
        // Si aucun mode n'est sélectionné, définir l'email comme valeur par défaut
        if (!formObject.mode_livraison_bdc) {
          formObject.mode_livraison_bdc = "email";
        }
      } else {
        // Si pas de bon de commande, pas de mode de livraison
        formObject.mode_livraison_bdc = "";
      }
      
      try {
        // Envoyer les données au webhook n8n
        const response = await fetch('https://n8n.dsolution-ia.fr/webhook/qualification-submission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formObject)
        });
        
        if (!response.ok) {
          throw new Error('Erreur lors de l\'envoi du formulaire');
        }
        
        // Afficher la confirmation
        document.getElementById('qualification-form').style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';
        
        // Scroll vers la confirmation
        document.getElementById('confirmation').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Erreur:', error);
        
        // Réactiver le bouton en cas d'erreur
        submitButton.disabled = false;
        submitButton.innerHTML = 'SOUMETTRE LA QUALIFICATION';
        
        // En cas d'échec du webhook, soumettre via Netlify Forms
        alert('Problème de connexion au serveur. Tentative alternative d\'envoi du formulaire...');
        
        const netlifyForm = document.createElement('form');
        netlifyForm.method = 'POST';
        netlifyForm.action = '/';
        netlifyForm.setAttribute('data-netlify', 'true');
        netlifyForm.setAttribute('name', 'qualification-form');
        
        // Ajouter chaque champ au formulaire Netlify
        Object.keys(formObject).forEach(key => {
          if (key !== 'form-name' && key !== 'bot-field') {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = formObject[key];
            netlifyForm.appendChild(input);
          }
        });
        
        // Ajouter le champ form-name
        const formNameInput = document.createElement('input');
        formNameInput.type = 'hidden';
        formNameInput.name = 'form-name';
        formNameInput.value = 'qualification-form';
        netlifyForm.appendChild(formNameInput);
        
        // Ajouter le formulaire au document et le soumettre
        document.body.appendChild(netlifyForm);
        netlifyForm.submit();
      }
    });
    
    // Fonction pour calculer le prix selon le format et le nombre de parutions
    function calculatePrice(format, nombreParutions) {
      if (!format) return 0;
      
      // Prix unitaires selon le format
      const prixUnitaires = {
        '6X4': 350,
        '6X8': 500,
        '12X4': 500,
        '12PARUTIONS': 1800 // Prix spécial pour l'offre annuelle
      };
      
      // Si c'est l'offre annuelle spéciale, retourner directement le prix forfaitaire
      if (format === '12PARUTIONS') {
        return prixUnitaires[format];
      }
      
      // Sinon calculer selon le nombre de parutions
      const prixUnitaire = prixUnitaires[format] || 350; // Par défaut 350€
      return prixUnitaire * nombreParutions;
    }
  </script>
  <script src="../assets/js/main.js" defer></script>
  <script src="../assets/js/prefillform-qualification.js" defer></script>
</body>
</html>
